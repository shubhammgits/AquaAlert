<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Dashboard â€¢ AquaAlert</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/portal.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body class="portal">
    <div class="app-layout">
      <aside class="sidebar sidebar--left" aria-label="Sidebar">
        <a href="/" class="sidebar__brand" style="text-decoration: none; color: inherit;">
          <div class="sidebar__app">AquaAlert</div>
          <div id="whoami" class="sidebar__who muted"></div>
        </a>

        <nav class="nav" aria-label="Main">
          <a class="nav__item" href="/">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 10.5 12 3l9 7.5" />
                <path d="M5 10v10h14V10" />
              </svg>
            </span>
            Home
          </a>

          <a class="nav__item is-active" href="#capture">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h7v7H4z" />
                <path d="M13 4h7v7h-7z" />
                <path d="M4 13h7v7H4z" />
                <path d="M13 13h7v7h-7z" />
              </svg>
            </span>
            Dashboard
          </a>

          <a class="nav__item" href="#myreports">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 6h13" />
                <path d="M8 12h13" />
                <path d="M8 18h13" />
                <path d="M3 6h.01" />
                <path d="M3 12h.01" />
                <path d="M3 18h.01" />
              </svg>
            </span>
            My Reports
          </a>

          <a class="nav__item" href="#verify">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 12l2 2 4-4" />
                <path d="M12 22a10 10 0 1 0-10-10" />
              </svg>
            </span>
            Verify Nearby
          </a>

          <a class="nav__item" href="#clusters">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 21s7-4.35 7-11a7 7 0 0 0-14 0c0 6.65 7 11 7 11Z" />
                <path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" />
              </svg>
            </span>
            Map
          </a>

          <a class="nav__item" href="#settings">
            <span class="nav__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" />
                <path d="M19.4 15a1.7 1.7 0 0 0 .34 1.87l.05.05a2.05 2.05 0 0 1-1.45 3.5 2.07 2.07 0 0 1-1.45-.6l-.05-.05a1.7 1.7 0 0 0-1.86-.34 1.7 1.7 0 0 0-1 1.55V22a2.05 2.05 0 0 1-4.1 0v-.07a1.7 1.7 0 0 0-1-1.55 1.7 1.7 0 0 0-1.87.34l-.05.05a2.07 2.07 0 0 1-1.45.6 2.05 2.05 0 0 1-1.45-3.5l.05-.05A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-1.55-1H3a2.05 2.05 0 0 1 0-4.1h.05A1.7 1.7 0 0 0 4.6 8.35a1.7 1.7 0 0 0-.34-1.87l-.05-.05A2.05 2.05 0 0 1 5.66 2.9c.54 0 1.07.21 1.45.6l.05.05a1.7 1.7 0 0 0 1.87.34 1.7 1.7 0 0 0 1-1.55V2a2.05 2.05 0 0 1 4.1 0v.07a1.7 1.7 0 0 0 1 1.55 1.7 1.7 0 0 0 1.86-.34l.05-.05c.38-.39.91-.6 1.45-.6a2.05 2.05 0 0 1 1.45 3.5l-.05.05a1.7 1.7 0 0 0-.34 1.87 1.7 1.7 0 0 0 1.55 1H22a2.05 2.05 0 0 1 0 4.1h-.07a1.7 1.7 0 0 0-1.55 1Z" />
              </svg>
            </span>
            Settings
          </a>
        </nav>

        <div class="sidebar__footer">
          <button class="btn btn-secondary" id="logoutBtn" type="button">Logout</button>
        </div>
      </aside>

      <main class="main">
        <div class="container">
          <section class="card" id="capture">
            <div class="card__head">
              <div>
                <h2 class="card__title">Capture New Report</h2>
                <p class="card__sub muted">Camera-only capture. No gallery uploads.</p>
              </div>
            </div>

            <div class="capture-grid">
              <div class="capture-grid__media">
                <div class="camera-shell">
                  <video id="video" class="video" autoplay playsinline></video>
                  <canvas id="canvas" class="hidden"></canvas>
                  <button id="captureBtn" class="capture" type="button">Capture</button>
                </div>
              </div>

              <div class="capture-grid__form">
                <div class="stack">
                  <label class="label">
                    District / Area
                    <input class="input" id="district" type="text" placeholder="e.g., North" required />
                  </label>
                  <div class="grid-2">
                    <label class="label">
                      State
                      <input class="input" id="state" type="text" placeholder="e.g., Delhi" />
                    </label>
                    <label class="label">
                      City
                      <input class="input" id="city" type="text" placeholder="e.g., Delhi" />
                    </label>
                  </div>
                  <label class="label">
                    Contact number
                    <input class="input" id="contactPhone" type="tel" placeholder="e.g., +91..." required />
                  </label>
                  <label class="label">
                    Description
                    <textarea class="input" id="desc" rows="3" placeholder="What do you see? (optional)"></textarea>
                  </label>
                  <button id="submitBtn" class="btn" type="button">Submit Report</button>
                  <p id="reportMsg" class="msg" aria-live="polite"></p>
                </div>
              </div>
            </div>
          </section>

          <section class="card" id="verify">
            <div class="card__head">
              <div>
                <h2 class="card__title">Verify Nearby Reports</h2>
                <p class="card__sub muted">Help confirm issues reported near you.</p>
              </div>
            </div>
        <div id="validationBox" class="list"></div>
          </section>

          <section class="card" id="clusters">
            <div class="card__head">
              <div>
                <h2 class="card__title">Nearby Issues (Clusters)</h2>
                <p class="card__sub muted">Live map view of active clusters near you.</p>
              </div>
            </div>
        <div id="map" class="map"></div>
          </section>

          <section class="card" id="myreports">
            <div class="card__head">
              <div>
                <h2 class="card__title">My Reports</h2>
                <p class="card__sub muted">Track progress from submission to resolution.</p>
              </div>
            </div>
        <div id="myReports" class="list"></div>
          </section>

          <section class="card" id="settings">
            <div class="card__head">
              <div>
                <h2 class="card__title">Settings</h2>
                <p class="card__sub muted">Account and session</p>
              </div>
            </div>
            <div class="stack">
              <button class="btn btn-secondary" id="logoutBtnInline" type="button">Logout</button>
            </div>
          </section>
        </div>
      </main>

      <aside class="sidebar sidebar--right" aria-label="User Activity">
        <div class="sidepanel">
          <div class="sidepanel__head">
            <h2 class="sidepanel__title">Previous Reports</h2>
            <div class="sidepanel__sub muted">History & status</div>
          </div>
          <div id="rightHistory" class="history" aria-live="polite"></div>
        </div>
      </aside>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/portal_ui.js"></script>
    <script src="/js/camera.js?v=3"></script>
    <script src="/js/map.js"></script>
    <script src="/js/validation.js"></script>
    <script>
      (async () => {
        requireAuthOrRedirect();
        document.getElementById("whoami").textContent = `Hello, ${getUserName()} (${getUserRole()})`;
        var inlineLogout = document.getElementById("logoutBtnInline");
        if (inlineLogout) inlineLogout.addEventListener("click", function () { document.getElementById("logoutBtn").click(); });
        await initCamera();
        await refreshMyReports();
        await initClusterMap("map");
        await refreshValidationCandidates();
      })();
    </script>
  </body>
</html>
